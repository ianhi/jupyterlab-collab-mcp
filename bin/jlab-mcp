#!/usr/bin/env bash
# jlab-mcp — Launch JupyterLab with collaboration extensions for MCP
#
# Usage:
#   jlab-mcp                        Launch JupyterLab
#   jlab-mcp [--no-extras] [args]   Launch with options
#   jlab-mcp list                   Show configured extensions
#   jlab-mcp add <pkg> [pkg...]     Add user extensions
#   jlab-mcp remove <pkg> [pkg...]  Remove user extensions
#
# Environment detection:
#   pyproject.toml present  → uv run (installs local package + deps + extras)
#   pixi.toml present       → pixi run (add extras to pixi.toml manually)
#   neither                 → uvx with all extras included
#
# Core extensions (always injected):
#   jupyterlab, jupyter-collaboration, jupyter-lsp, python-lsp-server
#
# User extensions are read from ~/.config/jlab-mcp/config.toml
# (respects $XDG_CONFIG_HOME). A default config is created on first run.

set -e

# ---------------------------------------------------------------------------
# Core extensions — required for MCP collaboration, always injected
# ---------------------------------------------------------------------------
CORE_EXTENSIONS=(
    jupyterlab
    jupyter-collaboration
    jupyter-lsp
    python-lsp-server
)

# ---------------------------------------------------------------------------
# Config file location (XDG-compliant)
# ---------------------------------------------------------------------------
CONFIG_DIR="${XDG_CONFIG_HOME:-$HOME/.config}/jlab-mcp"
CONFIG_FILE="$CONFIG_DIR/config.toml"

create_default_config() {
    mkdir -p "$CONFIG_DIR"
    write_config "jupyterlab-vim" "jupyterlab-myst" "jupyterlab-git"
    echo "Created config file: $CONFIG_FILE"
    echo "  Edit it to customize which extensions are loaded."
    echo ""
}

# Write config file with given extensions as arguments
write_config() {
    local header
    header="$(cat << 'HEADER'
# jlab-mcp configuration
#
# Extra packages to include when launching JupyterLab.
# Core extensions (jupyter-collaboration, jupyter-lsp, python-lsp-server)
# are always included and don't need to be listed here.
#
# To skip these extras temporarily, run: jlab-mcp --no-extras

HEADER
)"
    {
        echo "$header"
        echo "extensions = ["
        for pkg in "$@"; do
            echo "    \"$pkg\","
        done
        echo "]"
    } > "$CONFIG_FILE"
}

# ---------------------------------------------------------------------------
# Parse TOML config — extract extensions list
# ---------------------------------------------------------------------------
parse_extensions() {
    local file="$1"
    local in_array=0

    while IFS= read -r line; do
        # Strip leading/trailing whitespace
        line="${line#"${line%%[![:space:]]*}"}"
        line="${line%"${line##*[![:space:]]}"}"

        # Skip empty lines and comments
        [[ -z "$line" || "$line" == \#* ]] && continue

        # Detect start of extensions array
        if [[ "$line" =~ ^extensions[[:space:]]*=[[:space:]]*\[ ]]; then
            in_array=1
            # Handle inline entries after the opening bracket
            local after="${line#*[}"
            # Check if the array closes on the same line
            if [[ "$after" == *"]"* ]]; then
                after="${after%%]*}"
                in_array=0
            fi
            # Parse any entries on this line
            while IFS=',' read -ra parts; do
                for part in "${parts[@]}"; do
                    part="${part#"${part%%[![:space:]]*}"}"
                    part="${part%"${part##*[![:space:]]}"}"
                    part="${part#\"}"
                    part="${part%\"}"
                    part="${part#\'}"
                    part="${part%\'}"
                    part="${part%,}"
                    [[ -n "$part" ]] && echo "$part"
                done
            done <<< "$after"
            continue
        fi

        # Inside the array
        if (( in_array )); then
            # End of array
            if [[ "$line" == *"]"* ]]; then
                line="${line%%]*}"
                in_array=0
            fi
            # Strip quotes, commas, whitespace
            line="${line%%#*}"          # strip inline comments
            line="${line#"${line%%[![:space:]]*}"}"
            line="${line%"${line##*[![:space:]]}"}"
            line="${line%,}"
            line="${line#\"}"
            line="${line%\"}"
            line="${line#\'}"
            line="${line%\'}"
            line="${line#"${line%%[![:space:]]*}"}"
            line="${line%"${line##*[![:space:]]}"}"
            [[ -n "$line" ]] && echo "$line"
        fi
    done < "$file"
}

# ---------------------------------------------------------------------------
# Ensure config exists
# ---------------------------------------------------------------------------
if [[ ! -f "$CONFIG_FILE" ]]; then
    create_default_config
fi

# ---------------------------------------------------------------------------
# Subcommands: list, add, remove
# ---------------------------------------------------------------------------
case "${1:-}" in
    list)
        echo "Core extensions (always included):"
        for pkg in "${CORE_EXTENSIONS[@]}"; do
            echo "  - $pkg"
        done
        echo ""
        echo "User extensions (from $CONFIG_FILE):"
        EXTS=()
        while IFS= read -r ext; do
            EXTS+=("$ext")
        done < <(parse_extensions "$CONFIG_FILE")
        if (( ${#EXTS[@]} == 0 )); then
            echo "  (none)"
        else
            for pkg in "${EXTS[@]}"; do
                echo "  + $pkg"
            done
        fi
        exit 0
        ;;

    add)
        shift
        if (( $# == 0 )); then
            echo "Usage: jlab-mcp add <package> [package...]"
            exit 1
        fi
        # Read current extensions
        CURRENT=()
        while IFS= read -r ext; do
            CURRENT+=("$ext")
        done < <(parse_extensions "$CONFIG_FILE")
        # Add new ones (skip duplicates)
        for new_pkg in "$@"; do
            found=0
            for existing in "${CURRENT[@]}"; do
                if [[ "$existing" == "$new_pkg" ]]; then
                    found=1
                    break
                fi
            done
            if (( found )); then
                echo "Already configured: $new_pkg"
            else
                CURRENT+=("$new_pkg")
                echo "Added: $new_pkg"
            fi
        done
        write_config "${CURRENT[@]}"
        exit 0
        ;;

    remove)
        shift
        if (( $# == 0 )); then
            echo "Usage: jlab-mcp remove <package> [package...]"
            exit 1
        fi
        # Read current extensions
        CURRENT=()
        while IFS= read -r ext; do
            CURRENT+=("$ext")
        done < <(parse_extensions "$CONFIG_FILE")
        # Build new list excluding removed packages
        NEW_LIST=()
        for existing in "${CURRENT[@]}"; do
            keep=1
            for rm_pkg in "$@"; do
                if [[ "$existing" == "$rm_pkg" ]]; then
                    keep=0
                    echo "Removed: $rm_pkg"
                    break
                fi
            done
            (( keep )) && NEW_LIST+=("$existing")
        done
        # Warn about packages that weren't found
        for rm_pkg in "$@"; do
            found=0
            for existing in "${CURRENT[@]}"; do
                [[ "$existing" == "$rm_pkg" ]] && found=1 && break
            done
            (( found )) || echo "Not found: $rm_pkg"
        done
        write_config "${NEW_LIST[@]}"
        exit 0
        ;;

    --help|-h)
        echo "jlab-mcp — Launch JupyterLab with collaboration extensions for MCP"
        echo ""
        echo "Usage:"
        echo "  jlab-mcp                        Launch JupyterLab"
        echo "  jlab-mcp --no-extras [args]     Launch without user extensions"
        echo "  jlab-mcp list                   Show configured extensions"
        echo "  jlab-mcp add <pkg> [pkg...]     Add user extensions"
        echo "  jlab-mcp remove <pkg> [pkg...]  Remove user extensions"
        echo ""
        echo "Config: $CONFIG_FILE"
        echo "Also available as: jupyter-collab"
        exit 0
        ;;
esac

# ---------------------------------------------------------------------------
# Resolve uv — prefer native binary, fall back to npx @manzt/uv
# ---------------------------------------------------------------------------
if command -v uv &>/dev/null; then
    UV="uv"
    UVX="uvx"
elif command -v npx &>/dev/null; then
    echo "uv not found — falling back to npx @manzt/uv"
    echo "  (npx may prompt you to install it)"
    UV="npx @manzt/uv"
    UVX="npx @manzt/uvx"
else
    echo "Error: neither 'uv' nor 'npx' found in PATH."
    echo ""
    echo "Install uv:"
    echo "  curl -LsSf https://astral.sh/uv/install.sh | sh"
    echo ""
    echo "Or see: https://docs.astral.sh/uv/getting-started/installation/"
    exit 1
fi

# ---------------------------------------------------------------------------
# Parse flags
# ---------------------------------------------------------------------------
NO_EXTRAS=0
PASSTHROUGH_ARGS=()

for arg in "$@"; do
    if [[ "$arg" == "--no-extras" ]]; then
        NO_EXTRAS=1
    else
        PASSTHROUGH_ARGS+=("$arg")
    fi
done

# ---------------------------------------------------------------------------
# Build extension list
# ---------------------------------------------------------------------------
USER_EXTENSIONS=()
if (( ! NO_EXTRAS )) && [[ -f "$CONFIG_FILE" ]]; then
    while IFS= read -r ext; do
        USER_EXTENSIONS+=("$ext")
    done < <(parse_extensions "$CONFIG_FILE")
fi

ALL_EXTENSIONS=("${CORE_EXTENSIONS[@]}" "${USER_EXTENSIONS[@]}")

# Print what we're loading
echo "Core extensions:"
for pkg in "${CORE_EXTENSIONS[@]}"; do
    echo "  - $pkg"
done
if (( NO_EXTRAS )); then
    echo "User extensions: skipped (--no-extras)"
elif (( ${#USER_EXTENSIONS[@]} > 0 )); then
    echo "User extensions (from $CONFIG_FILE):"
    for pkg in "${USER_EXTENSIONS[@]}"; do
        echo "  + $pkg"
    done
else
    echo "User extensions: none configured"
fi
echo ""

# ---------------------------------------------------------------------------
# Port handling
# ---------------------------------------------------------------------------
PORT="${JUPYTER_PORT:-8888}"

if [[ ! "${PASSTHROUGH_ARGS[*]}" =~ --port ]]; then
    PORT_ARG="--port $PORT"
else
    PORT_ARG=""
fi

# ---------------------------------------------------------------------------
# Build --with args
# ---------------------------------------------------------------------------
WITH_ARGS=""
for pkg in "${ALL_EXTENSIONS[@]}"; do
    WITH_ARGS="$WITH_ARGS --with $pkg"
done

# ---------------------------------------------------------------------------
# Graceful shutdown handler
# ---------------------------------------------------------------------------
JUPYTER_PID=""
cleanup() {
    echo ""
    echo "Shutting down JupyterLab..."
    if [[ -n "$JUPYTER_PID" ]]; then
        kill -TERM "$JUPYTER_PID" 2>/dev/null || true
        for i in {1..6}; do
            if ! kill -0 "$JUPYTER_PID" 2>/dev/null; then
                echo "JupyterLab stopped."
                exit 0
            fi
            sleep 0.5
        done
        echo "Force killing hung process..."
        kill -9 "$JUPYTER_PID" 2>/dev/null || true
    fi
    exit 0
}
trap cleanup SIGINT SIGTERM

# ---------------------------------------------------------------------------
# Detect environment and launch
# ---------------------------------------------------------------------------
if [[ -f "pixi.toml" ]] || [[ -f "pixi.lock" ]]; then
    echo "Pixi project detected"
    echo "  Note: Add to pixi.toml for full support: ${ALL_EXTENSIONS[*]}"
    pixi run jupyter-lab $PORT_ARG "${PASSTHROUGH_ARGS[@]}" &
    JUPYTER_PID=$!

elif [[ -f "pyproject.toml" ]]; then
    echo "Python project detected — installing local package + extras..."
    $UV run $WITH_ARGS jupyter-lab $PORT_ARG "${PASSTHROUGH_ARGS[@]}" &
    JUPYTER_PID=$!

else
    echo "Standalone mode — launching JupyterLab with extras..."
    $UVX --from jupyterlab $WITH_ARGS jupyter-lab $PORT_ARG "${PASSTHROUGH_ARGS[@]}" &
    JUPYTER_PID=$!
fi

wait $JUPYTER_PID
