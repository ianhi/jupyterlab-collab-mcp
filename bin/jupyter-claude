#!/usr/bin/env bash
# Launch JupyterLab with Claude Code collaboration support
# Usage: jupyter-claude [jupyter lab args...]
#
# Automatically detects your environment:
# - In a uv project (pyproject.toml): installs local package + deps + extras
# - In a pixi project: uses pixi run (add extras to pixi.toml manually)
# - Standalone: uses uvx with all extras included
#
# Extras added (without modifying your project):
# - jupyter-collaboration (real-time sync for Claude Code)
# - jupyter-lsp + python-lsp-server (diagnostics/hover)
# - jupyterlab-vim (vim keybindings)

set -e

PORT="${JUPYTER_PORT:-8888}"

# Check if --port was passed in args
if [[ ! "$*" =~ --port ]]; then
    PORT_ARG="--port $PORT"
else
    PORT_ARG=""
fi

EXTRAS=(
    jupyterlab
    jupyter-collaboration
    jupyter-lsp
    python-lsp-server
    jupyterlab-vim
    jupyterlab-myst
    jupyterlab-git
)

# Build --with args
WITH_ARGS=""
for pkg in "${EXTRAS[@]}"; do
    WITH_ARGS="$WITH_ARGS --with $pkg"
done

# Handle Ctrl+C - force kill if graceful shutdown hangs
JUPYTER_PID=""
cleanup() {
    echo ""
    echo "Shutting down JupyterLab..."
    if [[ -n "$JUPYTER_PID" ]]; then
        # Send SIGTERM first
        kill -TERM "$JUPYTER_PID" 2>/dev/null || true
        # Wait up to 3 seconds
        for i in {1..6}; do
            if ! kill -0 "$JUPYTER_PID" 2>/dev/null; then
                echo "JupyterLab stopped."
                exit 0
            fi
            sleep 0.5
        done
        # Force kill if still running
        echo "Force killing hung process..."
        kill -9 "$JUPYTER_PID" 2>/dev/null || true
    fi
    exit 0
}
trap cleanup SIGINT SIGTERM

# Detect environment and launch appropriately
if [[ -f "pixi.toml" ]] || [[ -f "pixi.lock" ]]; then
    echo "ðŸ“¦ Pixi project detected"
    echo "   Note: Add to pixi.toml for full support: ${EXTRAS[*]}"
    pixi run jupyter-lab $PORT_ARG "$@" &
    JUPYTER_PID=$!

elif [[ -f "pyproject.toml" ]]; then
    echo "ðŸ“¦ Python project detected - installing local package + Claude Code extras..."
    uv run $WITH_ARGS jupyter-lab $PORT_ARG "$@" &
    JUPYTER_PID=$!

else
    echo "ðŸ““ Standalone mode - launching JupyterLab with Claude Code extras..."
    uvx --from jupyterlab $WITH_ARGS jupyter-lab $PORT_ARG "$@" &
    JUPYTER_PID=$!
fi

# Wait for jupyter to exit
wait $JUPYTER_PID
